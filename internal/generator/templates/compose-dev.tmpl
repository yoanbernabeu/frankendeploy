# FrankenDeploy - Docker Compose for Development
# Generated for {{ .Name }}

services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
      target: frankenphp_dev
    # SECURITY: Run as non-root user
    user: "{{ defaultUID }}:{{ defaultGID }}"
    ports:
      - "{{ devPort }}:{{ appPort }}"
      - "443:443"
      - "443:443/udp"
    volumes:
      - .:/app
      - vendor:/app/vendor
      - caddy_data:/data
      - caddy_config:/config
    environment:
      # SECURITY: Use non-privileged port {{ appPort }} for non-root execution
      SERVER_NAME: "${SERVER_NAME:-{{ if .Deploy.Domain }}{{ .Deploy.Domain }}{{ else }}localhost{{ end }}, :{{ appPort }}}"
      APP_ENV: dev
      APP_DEBUG: "1"
{{- if .Database.Driver }}
      DATABASE_URL: "{{ .DatabaseURL }}"
{{- end }}
{{- if .Env.Dev }}
{{- range $key, $value := .Env.Dev }}
      {{ $key }}: "{{ $value }}"
{{- end }}
{{- end }}
{{- if or (eq .Database.Driver "pgsql") (eq .Database.Driver "mysql") }}
    depends_on:
{{- if eq .Database.Driver "pgsql" }}
      database:
        condition: service_healthy
{{- else if eq .Database.Driver "mysql" }}
      database:
        condition: service_healthy
{{- end }}
{{- end }}

{{- if eq .Database.Driver "pgsql" }}

  database:
    image: postgres:{{ .Database.Version }}-alpine
    environment:
      POSTGRES_USER: {{ .DevDBUser }}
      POSTGRES_PASSWORD: {{ .DevDBPassword }}
      POSTGRES_DB: {{ .DevDBName }}
    ports:
      - "5432:5432"
    volumes:
      - db_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U {{ .DevDBUser }} -d {{ .DevDBName }}"]
      interval: 5s
      timeout: 5s
      retries: 5
{{- end }}

{{- if eq .Database.Driver "mysql" }}

  database:
    image: mysql:{{ .Database.Version }}
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_USER: {{ .DevDBUser }}
      MYSQL_PASSWORD: {{ .DevDBPassword }}
      MYSQL_DATABASE: {{ .DevDBName }}
    ports:
      - "3306:3306"
    volumes:
      - db_data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 5s
      timeout: 5s
      retries: 5
{{- end }}

{{- if .HasMailer }}

  mailhog:
    image: mailhog/mailhog
    ports:
      - "1025:1025"
      - "8025:8025"
{{- end }}

{{- if .HasMessenger }}

  rabbitmq:
    image: rabbitmq:3-management-alpine
    ports:
      - "5672:5672"
      - "15672:15672"
    environment:
      RABBITMQ_DEFAULT_USER: {{ .DevDBUser }}
      RABBITMQ_DEFAULT_PASS: {{ .DevDBPassword }}
{{- end }}

volumes:
  vendor:
  caddy_data:
  caddy_config:
{{- if or (eq .Database.Driver "pgsql") (eq .Database.Driver "mysql") }}
  db_data:
{{- end }}
