#!/bin/sh
set -e

# FrankenDeploy - Docker Entrypoint
# Handles startup tasks before FrankenPHP

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

log_info() {
    echo "${GREEN}[FrankenDeploy]${NC} $1"
}

log_warn() {
    echo "${YELLOW}[FrankenDeploy]${NC} $1"
}

log_error() {
    echo "${RED}[FrankenDeploy]${NC} $1"
}

# Wait for database to be ready
wait_for_database() {
    if [ -n "$DATABASE_URL" ]; then
        case "$DATABASE_URL" in
            postgresql://*)
                DB_HOST=$(echo "$DATABASE_URL" | sed -E 's|postgresql://[^@]+@([^:/]+).*|\1|')
                DB_PORT=$(echo "$DATABASE_URL" | sed -E 's|postgresql://[^@]+@[^:]+:([0-9]+).*|\1|')
                DB_PORT=${DB_PORT:-5432}
                ;;
            mysql://*)
                DB_HOST=$(echo "$DATABASE_URL" | sed -E 's|mysql://[^@]+@([^:/]+).*|\1|')
                DB_PORT=$(echo "$DATABASE_URL" | sed -E 's|mysql://[^@]+@[^:]+:([0-9]+).*|\1|')
                DB_PORT=${DB_PORT:-3306}
                ;;
            sqlite://*)
                return 0
                ;;
            *)
                return 0
                ;;
        esac

        if [ -n "$DB_HOST" ] && [ "$DB_HOST" != "localhost" ]; then
            log_info "Waiting for database at $DB_HOST:$DB_PORT..."
            ATTEMPTS=0
            MAX_ATTEMPTS=30
            until nc -z "$DB_HOST" "$DB_PORT" 2>/dev/null || [ $ATTEMPTS -eq $MAX_ATTEMPTS ]; do
                ATTEMPTS=$((ATTEMPTS + 1))
                sleep 1
            done
            if [ $ATTEMPTS -eq $MAX_ATTEMPTS ]; then
                log_error "Database not available"
                exit 1
            fi
            log_info "Database is ready!"
        fi
    fi
}

# Restore pre-built assets from Docker image (for volume mounts in dev)
restore_assets() {
    if [ -d /app-assets ]; then
        if [ ! -d /app/var/sass ] && [ -d /app-assets/sass ]; then
            log_info "Restoring pre-built Sass assets..."
            mkdir -p /app/var
            cp -r /app-assets/sass /app/var/
        fi
        if [ ! -d /app/public/assets ] && [ -d /app-assets/assets ]; then
            log_info "Restoring pre-built assets..."
            mkdir -p /app/public
            cp -r /app-assets/assets /app/public/
        fi
    fi
}

# Fix permissions for var directory
fix_permissions() {
    if [ -d /app/var ]; then
        chmod -R 775 /app/var 2>/dev/null || true
    fi
}

# Main
main() {
    cd /app

    if [ "$APP_ENV" = "dev" ]; then
        log_info "Starting in DEVELOPMENT mode"
        fix_permissions
        restore_assets
        wait_for_database
    else
        log_info "Starting in PRODUCTION mode"
        wait_for_database
    fi

    log_info "Starting FrankenPHP..."
    exec "$@"
}

main "$@"
